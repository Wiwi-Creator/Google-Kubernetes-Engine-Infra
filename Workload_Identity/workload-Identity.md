---
title: 'Workload-Identity'
---

Workload-Identity
===

## Workload-Identity
--- 
Applications often need to authenticate (provide an authenticatable identity) when connecting to other services.
應用程式通常一些認證才得以連接其他服務。
And fleet Workload Identity is the recommended way for application workloads hosted in a fleet to authenticate to Google Cloud APIs and services.
而 fleet Workload Identity 則是最推薦提供App工作負載 去和GCP API / 服務作認證的方式。
### What is Fleet Workload-Identity?

Fleet Workload Identity extends the functionality provided in GKE Workload Identity, which lets the workloads in your cluster authenticate to Google without requiring you to download, manually rotate, and generally manage Google Cloud service account keys. Instead, workloads authenticate using short-lived tokens generated by the cluster. All clusters with GKE Workload Identity enabled use their project's workload identity pool when issuing IDs, which allows Identity and Access Management to trust and understand Kubernetes service account credentials.

它擴展了GKE中工作負載的功能。使cluster中的工作負載 可以不需透過下載,管理GSA。
GKE可以直接使用 workload identity pool (允許 Access Management 信任你的 KSA)

### How it works?
Use *workload identity federation* to make your app  with a distinct federated identity that can be used to authenticate to Google Cloud and other services you develop.(Like the following format)
使用了聯合工作負載 使你的應用程式可以特別使用一個認證去連接GCP

```
serviceAccount:FLEET_PROJECT_ID.svc.id.goog[K8S_NAMESPACE/KSA_NAME]
```
註:

FLEET_PROJECT_ID.svc.id.goog is a short-form representation of the workload identity pool for your fleet. There is only one fixed workload identity pool per fleet and it is automatically created for you.

K8S_NAMESPACE is the Kubernetes namespace where the Kubernetes service account is defined.

KSA_NAME is the name of the Kubernetes service account attached to the application.


### step1. Setting Cluster

If Autopilot-cluster , Which do not require any configuration of workload-identity or workload-pools.

It automatically assigns service accounts and workload-identity to your Pods.

如果使用的是Autopilot-cluster，不用再手動建立或修改 Workload-pool，因為會自動Default分配

### step2. Create KSA
Create a Kubernetes service account for your application to use.

```
kubectl create serviceaccount KSA_NAME --namespace NAMESPACE
```

### step3. Configure applications to use Workload Identity

Allow the KSA to impersonate the IAM service account by adding an IAM policy binding between the two service accounts.

This binding allows the Kubernetes service account to act as the IAM service account.

```
gcloud iam service-accounts add-iam-policy-binding GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com \
    --role roles/iam.workloadIdentityUser \
    --member "serviceAccount:PROJECT_ID.svc.id.goog[NAMESPACE/KSA_NAME]"
```
### step4. Annotate KSA

```
kubectl annotate serviceaccount KSA_NAME \
    --namespace NAMESPACE \
    iam.gke.io/gcp-service-account=GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com
```

### step5. Update Spec on Pod .

Update Pod spec to schedule the workloads on nodes that use Workload Identity and to use the annotated Kubernetes service account.

```
spec:
  serviceAccountName: KSA_NAME
  nodeSelector:
    iam.gke.io/gke-metadata-server-enabled: "true"
```

這樣Pod便可以使用建立的KSA，且該KSA已經有了和 GSA 相同的權限。

### Reference:
- [Kubernetes](https://docs.docker.com/get-started/overview/)
- [Google Kubernetes Engine](https://docs.docker.com/engine/reference/commandline/cli/)
- [GKE-ip-masq_agent](https://cloud.google.com/kubernetes-engine/docs/how-to/ip-masquerade-agent?hl=zh-cn)
- [GKE-Cloud_NAT_policy](https://cloud.google.com/kubernetes-engine/docs/how-to/egress-nat-policy-ip-masq-autopilot)
- [GKE-Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
- [Container Registry](https://cloud.google.com/container-registry/docs)